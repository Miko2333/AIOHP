<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Document</title>
		{% load static %}

		<link rel="shortcut icon" href="{% static 'img/favicon.png' %}" />

		<!-- CSS -->
		<link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %}">
		<link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap-select.min.css' %}">
		<link href="{% static 'plugins/icons/css/icons.css' %}" rel="stylesheet">
		<link href="{% static 'plugins/animate/animate.css' %}" rel="stylesheet">
		<link href="{% static 'plugins/bootstrap/css/bootsnav.css' %}" rel="stylesheet">
		<link rel="stylesheet" href="{% static 'plugins/nice-select/css/nice-select.css' %}">
		<link href="{% static 'plugins/aos-master/aos.css' %}" rel="stylesheet">
		<link href="{% static 'css/style.css' %}" rel="stylesheet">
		<link href="{% static 'css/responsive.css' %}" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
		<!-- Google Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700&display=swap"
			rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600&display=swap" rel="stylesheet">
	</head>
	<body class="utf_skin_area">
		<div class="page_preloader"></div>
		<meta name="csrf-token" content="{{ csrf_token }}">
		<!-- ======================= Start Navigation ===================== -->
		<nav class="navbar navbar-default navbar-mobile navbar-fixed white no-background bootsnav">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu"> <i
							class="fa fa-bars"></i> </button>
					<a class="navbar-brand" href="index.html"> <img src="{% static 'img/logo1.svg' %}"
							class="logo logo-display" alt=""> <img src="{% static 'img/logo1.svg' %}"
							class="logo logo-scrolled" alt=""> </a>
				</div>
				<div class="collapse navbar-collapse" id="navbar-menu">
					<ul class="nav navbar-nav navbar-left" data-in="fadeInDown" data-out="fadeOutUp">
						<li class="dropdown active"> <a href="/">主页</a> </li>
						<li class="dropdown active"> <a href="/courses">课程清单</a> </li>
						
</ul>
					<ul class="nav navbar-nav navbar-right">
						<li id="login" class="br-right" style="cursor: pointer;"><a class="btn-signup red-btn"
								data-toggle="modal" data-target="#signin"><i class="login-icon ti-user"></i>Login</a>
						</li>
						<li id="exit" class="br-right" style="cursor: pointer; display: none;"><a
								class="btn-signup red-btn"><i class="login-icon ti-user"></i>EXIT</a></li>
						<li class="sign-up" id="register" style="cursor: pointer;"><a class="btn-signup red-btn"
								href="signup"><span class="ti-briefcase"></span>Register</a></li>
						<li class="status-container sign-up " id="user-info" style="display: none; margin: 25px;">
							<span id="login-status" class="status-text"></span>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<!-- ======================= End Navigation ===================== -->

		<!-- ======================= Start Banner ===================== -->
		<div class="utf_main_banner_area" style="background-image:url({% static 'img/mainpage-1.jpg' %});"
			data-overlay="8">
			<div class="container">
				<div class="col-md-8 col-sm-10">
					<div class="caption cl-white home_two_slid">
						<h2>AIOHP代码评测平台提供超过 <span class="theme-cl">50,000</span> 门课程.</h2>
						<p>优质课程： <span class="trending_key"><a href="#">Algorithm Design</a></span>
							<span class="trending_key"><a href="#">Database</a></span> <span class="trending_key"><a
									href="#">Data Structure</a></span> <span class="trending_key"><a href="#">
									Software Developing</a></span>
						</p>
					</div>
					<form>
						<fieldset class="utf_home_form_one">
							<div class="col-md-4 col-sm-4 padd-0">
								<input type="text" class="form-control br-1" placeholder="Search Keywords..." />
							</div>
							<div class="col-md-3 col-sm-3 padd-0">
								<select class="wide form-control br-1">
									<option data-display="Degree">All Grades</option>
									<option value="0">Undergraduate 1</option>
									<option value="1">Undergraduate 2</option>
									<option value="2">Undergraduate 3</option>
									<option value="3">Undergraduate 4</option>
									<option value="4">Master</option>
									<option value="5">PHD</option>
									<option value="6">Comeitition</option>
									<option value="7">High school</option>
								</select>
							</div>
							<div class="col-md-3 col-sm-3 padd-0">
								<select class="wide form-control">
									<option data-display="Category">Show All</option>
									<option value="1">Software Developer</option>
									<option value="2">Java Developer</option>
									<option value="3">Software Engineer</option>
									<option value="4">Web Developer</option>
									<option value="5">PHP Developer</option>
									<option value="6">Python Developer</option>
									<option value="7">Front end Developer</option>
									<option value="8">Associate Developer</option>
									<option value="9">Back end Developer</option>
									<option value="10">XML Developer</option>
									<option value="11">.NET Developer</option>
									<option value="12" disabled>Marketting Developer</option>
								</select>
							</div>
							<div class="col-md-2 col-sm-2 padd-0 m-clear">
								<li  class="btn theme-btn cl-white seub-btn"><a href="/courses">Start</a></li>
							</div>
						</fieldset>
					</form>
				</div>
			</div>
		</div>
		<!-- ======================= End Banner ===================== -->
		<div class="modal fade" id="signin" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1"
			aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content" id="myModalLabel1">
					<div class="modal-body">
						<!-- Nav tabs -->
						<ul class="nav nav-tabs nav-advance theme-bg" role="tablist">
							<li class="nav-item active"> <a class="nav-link" data-toggle="tab" href="#employer"
									role="tab"> <i class="ti-user"></i> 学生</a> </li>
							<li class="nav-item"> <a class="nav-link" data-toggle="tab" href="#candidate" role="tab"> <i
										class="ti-user"></i>教师</a> </li>
						</ul>
						<!-- Nav tabs -->
						<!-- Tab panels -->
						<div class="tab-content">
							<!-- Employer Panel 1-->
							<!-- Employer Panel 1-->
							<div class="tab-pane fade in show active" id="employer" role="tabpanel">
								<form id="employerLoginForm">
									<div class="form-group">
										<input type="text" id="employerUsername" class="form-control"
											placeholder="Username">
									</div>
									<div class="form-group">
										<input type="password" id="employerPassword" class="form-control"
											placeholder="Password">
									</div>

		
									<div class="form-group text-center">
										<button type="button" class="btn theme-btn full-width btn-m"
											id="employerLoginButton">Login</button>
									</div>
									<div class="form-group">
										<p id="employerError" style="color: red; display: none;"></p>
									</div>
								</form>
	
							</div>
							<!--/.Panel 1-->
		
							<!-- Candidate Panel 2-->
							<div class="tab-pane fade" id="candidate" role="tabpanel">
								<form id="candidateLoginForm">
									<div class="form-group">
										<input type="text" id="candidateUsername" class="form-control"
											placeholder="Username">
									</div>
									<div class="form-group">
										<input type="password" id="candidatePassword" class="form-control"
											placeholder="Password">
									</div>

									<div class="form-group text-center">
										<button type="button" class="btn theme-btn full-width btn-m"
											id="candidateLoginButton">LogIn</button>
									</div>
									<div class="form-group">
										<p id="candidateError" style="color: red; display: none;"></p>
									</div>
								</form>
								
							</div>
						</div>
						<!-- Tab panels -->
					</div>
				</div>
			</div>
		</div>
		

<div><a href="#" class="scrollup">Scroll</a></div>

		<!-- Jquery js-->
		<script src="{% static 'js/jquery.min.js' %}"></script>
		<script src="{% static 'plugins/bootstrap/js/bootstrap.min.js' %}"></script>
		<script src="{% static 'plugins/bootstrap/js/bootsnav.js' %}"></script>
		<script src="{% static 'js/viewportchecker.js' %}"></script>
		<script src="{% static 'js/slick.js' %}"></script>
		<script src="{% static 'plugins/bootstrap/js/wysihtml5-0.3.0.js' %}"></script>
		<script src="{% static 'plugins/bootstrap/js/bootstrap-wysihtml5.js' %}"></script>
		<script src="{% static 'plugins/aos-master/aos.js' %}"></script>
		<script src="{% static 'plugins/nice-select/js/jquery.nice-select.min.js' %}"></script>
		<script src="{% static 'js/custom.js' %}"></script>
		<script>
			$(window).load(function() {
				$(".page_preloader").fadeOut("slow");
			});
			AOS.init();
		</script>


		<script>
			document.addEventListener('DOMContentLoaded', (event) => {
				checkLoginStatus();
			});

			function checkLoginStatus() {
				const accessToken = localStorage.getItem('access');
				if (!accessToken) {
					document.getElementById('login-status').textContent = '用户未登录。';
					return;
				}

				fetch('/api/check_login_status/', {
						method: 'GET',
						headers: {
							'Content-Type': 'application/json',
							'Authorization': 'Bearer ' + accessToken
						}
					})
					.then(response => {
						if (response.status === 403) {
							console.log('用户未认证。');
							document.getElementById('login-status').textContent = '用户未登录。';
						} else if (response.ok) {
							return response.json();
						} else {
							throw new Error('网络响应不正常。');
						}
					})
					.then(data => {
						if (data) {
							console.log('登录状态：', data);
							const loginStatus = document.getElementById('login-status');
							const userInfo = document.getElementById('user-info');

							if (data.logged_in) {
								console.log('用户已登录为：', data.username);
								$("#user-info").show();
								$("#register").hide();
								$("#login").hide();
								$("#exit").show();
								userInfo.innerHTML = '<i class="login-icon ti-user"></i> 欢迎：' + data.username;
							} else {
								console.log('用户未登录。');
								$("#user-info").hide();
								$("#register").show();
								$("#login").hide();
								$("#exit").hide();
								userInfo.innerHTML = '';
								userInfo.textContent = '';
							}
						}
					})
					.catch(error => {
						console.error('错误：', error);
					});
			}
		</script>

		<script>
			document.getElementById('exit').addEventListener('click', function(event) {
				event.preventDefault();

				// 清除本地存储中的用户信息
				localStorage.removeItem('access');
				localStorage.removeItem('refresh');
				localStorage.removeItem('user_id');
				localStorage.removeItem('username');

				// 重定向到登录页面或主页
				window.location.href = '/'; // 修改为您的登录页面路径
			});
		</script>
		<script>
			document.addEventListener('DOMContentLoaded', function() {
				document.getElementById('employerLoginButton').addEventListener('click', async function(event) {
					event.preventDefault();
					const username = document.getElementById('employerUsername').value;
					const password = document.getElementById('employerPassword').value;
					try {
						var lists = await getlist('students');
						var userExists = lists.some(function(user) {
							return user.name == username;
						});
						if (userExists) {
							login(username, password, 'employerError', 'student');
						} else {
							const errorElement = document.getElementById('employerError');
							errorElement.textContent = 'Invalid credentials';
							errorElement.style.display = 'block';
						}
					} catch (error) {
						console.error("Error fetching student list:", error);
					}
				});

				document.getElementById('candidateLoginButton').addEventListener('click', async function(event) {
					event.preventDefault();
					const username = document.getElementById('candidateUsername').value;
					const password = document.getElementById('candidatePassword').value;
					try {
						var lists = await getlist('teachers');
						var userExists = lists.some(function(user) {
							return user.name == username;
						});
						if (userExists) {
							login(username, password, 'candidateError', 'teacher');
						} else {
							const errorElement = document.getElementById('candidateError');
							errorElement.textContent = 'Invalid credentials';
							errorElement.style.display = 'block';

						}
					} catch (error) {

						console.error("Error fetching teacher list:", error);
					}
				});

				async function getlist(name) {
					var users = [];
					try {
						const response = await $.ajax({
							type: 'GET',
							url: '/api/' + name,
							contentType: 'application/json'
						});
						users = response;
						console.log('users fetched successfully:', users);
					} catch (error) {
						console.log('Failed to fetch users:', error);
					}
					return users;
				}

				function login(username, password, errorElementId, role) {
					fetch('/api/login', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'X-CSRFToken': getCookie('csrftoken') // 包含 CSRF token
							},
							body: JSON.stringify({
								username: username,
								password: password,
							})
						})
						.then(response => {
							if (response.ok) {
								return response.json();
							} else {
								return response.json().then(data => {
									throw new Error(data.error || 'Login failed');
								});
							}
						})
						.then(data => {
							console.log('Login Success:', data);
							// 保存 token 到 localStorage
							localStorage.setItem('access', data.access);
							localStorage.setItem('refresh', data.refresh);
							localStorage.setItem('user_id', data.user);
							localStorage.setItem('user_role', role);
							window.location.href = '/'; // 跳转到主页
						})
						.catch((error) => {
							console.error('Login Error:', error);
							const errorElement = document.getElementById(errorElementId);
							errorElement.textContent = error.message;
							errorElement.style.display = 'block';
						});
				}

				function getCookie(name) {
					let cookieValue = null;
					if (document.cookie && document.cookie !== '') {
						const cookies = document.cookie.split(';');
						for (let i = 0; i < cookies.length; i++) {
							const cookie = cookies[i].trim();
							if (cookie.substring(0, name.length + 1) === (name + '=')) {
								cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
								break;
							}
						}
					}
					return cookieValue;
				}
			});
		</script>
	</body>
</html>